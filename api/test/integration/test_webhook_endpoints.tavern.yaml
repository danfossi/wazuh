---
test_name: POST /events

stages:

  - name: Send bulk with one element
    request: &webhook_request
      verify: false
      url: "{protocol:s}://{host:s}:{port:d}/events"
      method: POST
      headers:
        Authorization: "Bearer {test_login_token}"
      json:
        events:
          - foo event
    response:
      status_code: 200
      json:
        data:
          affected_items:
            - foo event
          total_affected_items: 1
          total_failed_items: 0
          failed_items: []
        message: All events were forwarded to analisysd
        error: 0

  - name: POST /events with multiple elements
    request:
      verify: false
      <<: *webhook_request
      json:
        events:
          - foo event
          - bar event
          - gaz event
    response:
      status_code: 200
      json:
        data:
          affected_items:
            - foo event
            - bar event
            - gaz event
          total_affected_items: 3
          total_failed_items: 0
          failed_items: []
        message: All events were forwarded to analisysd
        error: 0


---
test_name: POST /events with invalid formats

stages:
  - name: POST /events with invalid event type
    request:
      verify: false
      <<: *webhook_request
      json:
        events:
          - "foo": 1
    response:
      status_code: 400
      json:
        detail: "{{'foo': 1}} is not of type 'string' - 'events.0'"
        title: Bad Request

  - name: POST /events with invalid body
    request:
      verify: false
      <<: *webhook_request
      json:
        - foo
        - bar
    response:
      status_code: 400
      json:
        detail: "['foo', 'bar'] is not of type 'object'"
        title: Bad Request

---

test_name: POST /events with more than 100 events

marks:
  - usefixtures:
      - big_events_payload

stages:
  - name: POST /events with invalid size
    request:
      verify: false
      <<: *webhook_request
      json:
        events: !force_format_include "{big_events_payload}"
    response:
      status_code: 400
      json:
        detail: The size of the events bulk is exceeding the limit
        title: Events bulk size exceeded

---

test_name: POST /events more than 30 times trigger the EPS limit

stages:
  - name: Trigger EPS limit
    max_retries: 30
    request:
      verify: false
      <<: *webhook_request
      json:
        events:
          - foo
    response:
      status_code: 429
    delay_before: 1
