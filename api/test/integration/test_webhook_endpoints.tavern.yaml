---
test_name: POST /events

marks:
  - usefixtures:
      - forwarded_events

stages:

  - name: Send bulk with one element
    request: &webhook_request
      verify: false
      url: "{protocol:s}://{host:s}:{port:d}/events"
      method: POST
      headers:
        Authorization: "Bearer {test_login_token}"
      json:
        events: [
          {"foo": 1},
        ]

    response:
      verify_response_with:
        - function: tavern_utils:assert_forwarded_events
          extra_kwargs:
            forwarded_events: "{forwarded_events}"
            expected_events: 1
      status_code: 200
      json: &webhook_response_ok
        message: The events where successfully forwarded
        error: 0

  - name: POST /events with multiple elements
    request:
      verify: false
      <<: *webhook_request
      json:
        events: [
          {"foo": 1},
          {"bar": 2},
          {"gaz": 3},
        ]

    response:
      verify_response_with:
        - function: tavern_utils:assert_forwarded_events
          extra_kwargs:
            forwarded_events: "{forwarded_events}"
            expected_events: 4
      status_code: 200
      json:
        <<: *webhook_response_ok
---

test_name: POST /events tree times in less than a minute and trigger the EPS limit

stages:
  - name: First request OK
    request:
      verify: false
      <<: *webhook_request
      json:
        events: [
          {"foo": 1},
          {"bar": 2},
          {"gaz": 3},
          {"foo": 4},
          {"bar": 5},
        ]
    response:
      status_code: 200
      json:
        <<: *webhook_response_ok

  - name: Second request OK
    request:
      verify: false
      <<: *webhook_request
      json:
        events: [
          {"foo": 1},
          {"bar": 2},
          {"gaz": 3},
          {"foo": 4},
          {"bar": 5},
        ]
    response:
      status_code: 200
      json:
        <<: *webhook_response_ok

  - name: Third request and get 429 code
    request:
      verify: false
      <<: *webhook_request
      json:
        events: [
          {"foo": 1},
          {"bar": 2},
          {"gaz": 3},
          {"foo": 4},
          {"bar": 5},
        ]
    response:
      status_code: 429
      json: &webhook_response_bad
        detail: !anystr
        title: !anystr


---
test_name: POST /events bad requests

stages:

  - name: POST /events with invalid body
    request:
      verify: false
      <<: *webhook_request
      json:
        [
          {"foo": 1},
          {"bar": 2}
        ]
    response:
      status_code: 400
      json:
        <<: *webhook_response_bad


  - name: POST /events with invalid size
    request:
      verify: false
      <<: *webhook_request
      json:
        events: [
          {"foo": 1},
          {"bar": 2},
          {"bar": 3},
          {"bar": 4},
          {"bar": 5},
          {"bar": 6},
        ]
    response:
      status_code: 400
      json:
        <<: *webhook_response_bad
